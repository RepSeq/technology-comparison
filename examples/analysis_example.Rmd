---
title: "An example of data analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Libraries

```{r}
library(dplyr)
library(ggplot2)
library(RColorBrewer)
library(scales)
```

Auxiliary functions

```{r}
get_segment_id = function(s) {
  unlist(lapply(strsplit(s, "*", fixed=T), function(x) x[1]))
}

read_mixcr = function(file_name) {
  .df = read.table(file_name, header=T, stringsAsFactors = F, sep="\t", fill = T) %>%
    select(Clone.ID, Clone.count, All.V.hits, All.D.hits, All.J.hits, N..Seq..CDR3, AA..Seq..CDR3)
  colnames(.df) = c("clone.id", "count", "v", "d", "j", "cdr3nt", "cdr3aa")
  .df$freq = .df$count / sum(.df$count)
  
  .df %>% mutate(v=get_segment_id(v),d=get_segment_id(d),j=get_segment_id(j))
}


head(read_mixcr("chudakovlab/A1_8_alpha.txt.gz"))
```

Read samples

```{r}
df = data.frame()
for (chain in c("alpha", "beta")) {
for (replica in c("A1", "A2", "A3")) {
  file_name = paste0("chudakovlab/", replica, "_", 8, "_", chain, ".txt.gz")
  .df = read_mixcr(file_name)
  .df$replica = replica
  .df$chain = chain
  .df$amount = "8ng"
  df = rbind (df, .df)
}
for (replica in c("B", "C", "D")) {
  file_name = paste0("chudakovlab/", replica, "_", 65, "_", chain, ".txt.gz")
  .df = read_mixcr(file_name)
  .df$replica = replica
  .df$chain = chain
  .df$amount = "65ng"
  df = rbind (df, .df)
}
}

summary(df)
```

## Basic repertoire properties

### Segment usage

Summarize data

```{r}
df.segm = df %>%
  group_by(replica, chain, amount, v, j) %>%
  summarize(freq = sum(freq), uniq = n()) %>%
  group_by(replica) %>%
  mutate(freq.rank = rank(-freq))  

df.segm.v = df.segm %>%
  group_by(replica, chain, amount, v) %>%
  summarize(freq = sum(freq), uniq = sum(uniq)) %>%
  group_by(v) %>%
  mutate(freq.tot = mean(freq))

df.segm.v$v <- factor(df.segm.v$v, levels=df.segm.v$v[order(df.segm.v$freq.tot)])

df.segm.j = df.segm %>%
  group_by(replica, chain, amount, j) %>%
  summarize(freq = sum(freq), uniq = sum(uniq))  %>%
  group_by(j) %>%
  mutate(freq.tot = mean(freq))

df.segm.j$j <- factor(df.segm.j$j, levels=df.segm.j$j[order(df.segm.j$freq.tot)])
```

Variable segment usage

```{r}
ggplot(df.segm.v, aes(x=v, y=freq, color=amount, linetype=replica)) +
  geom_point() + 
  geom_line(aes(group=replica)) +
  coord_flip() +
  facet_wrap(~chain, scales="free") + 
  xlab("Frequency") + ylab("") +
  scale_color_brewer(palette = "Set1") + 
  theme_light()

a <- aov(freq ~ v + amount : v, df.segm.v)
summary(a)
```

Joining segment usage

```{r}
ggplot(df.segm.j, aes(x=j, y=freq, color=amount, linetype=replica)) +
  geom_point() + 
  geom_line(aes(group=replica)) +
  coord_flip() +
  xlab("Frequency") + ylab("") +
  facet_wrap(~chain, scales="free") + 
  scale_color_brewer(palette = "Set1") + 
  theme_light()

a <- aov(freq ~ j + amount : j, df.segm.j)
summary(a)
```

> Note that there is some difference is segment usage related to the starting amount of RNA

V-J segment usage

```{r}
ggplot(df.segm, aes(x=freq.rank, y=freq, color=replica)) +
  geom_point(shape=21) + 
  scale_x_log10("V-J pair rank") + scale_y_log10("Frequency") +
  facet_grid(chain~amount, scales="free") + 
  scale_color_brewer(palette = "Paired") + 
  theme_light()
```

### Spectratype

```{r}
df.sp = df %>%
  mutate(cdr3.len = nchar(cdr3nt)) %>%
  group_by(replica, chain, amount, cdr3.len) %>%
  summarize(freq = sum(freq), uniq=n())
```

CDR3 length distribution and out-of-frame sequences

```{r}
library(scales)
df.sp$in.frame = ifelse(df.sp$cdr3.len %% 3 == 0, "in-frame", "out-of-frame")
ggplot(df.sp, aes(x=cdr3.len, y=freq, fill=amount, color=amount)) +
  geom_boxplot(aes(group=interaction(cdr3.len,amount))) +
  scale_x_continuous("CDR3 nucleotide sequence length", limits=c(21,66), breaks = seq(21,66,by=3)) + 
  scale_y_continuous("", labels=percent) +
  facet_grid(in.frame~chain, scales="free") + 
  scale_fill_brewer(palette = "Set1") + 
  scale_color_brewer(palette = "Set1") + 
  theme_light()
```

## Clonotype abundance quantification

Clonotype frequency and rank

```{r}
ggplot(df, aes(x=clone.id, y=freq, linetype=replica, group=replica, color=amount)) + 
  geom_line() + 
  scale_y_log10() + scale_x_log10() + 
  facet_grid(~chain, scales="free") + 
  scale_color_brewer(palette = "Set1") + 
  theme_light()
```

Do 

```{r}
df.1 = df %>%
  select(cdr3nt, replica, amount, count, chain)

dummy = expand.grid(cdr3nt = unique(df.1$cdr3nt),
                    replica = unique(df.1$replica),
                    chain = unique(df.1$chain),
                    amount = unique(df.1$amount))

real_ccdr = interaction(df.1$chain, df.1$cdr3nt)
dummy = subset(dummy, interaction(chain, cdr3nt) %in% real_ccdr)
dummy$count = 0
df.1 = rbind(df.1, dummy)

df.1 = df.1 %>%
  mutate(count.grand = sum(count)) %>%
  group_by(cdr3nt) %>%
  mutate(count.total = sum(count)) %>%
  group_by(replica) %>%
  mutate(count.replica.total = sum(count))
```

Clonotype frequency in different replicas versus clonotype frequency estimated from pooled sample

```{r}
ggplot(subset(df.1,count>0), aes(x=count.total/count.grand, 
                                  y=count/count.replica.total)) +
  geom_point(aes(color=replica), shape=21) + 
  geom_abline(slope = 1, intercept = 0, color="black", linetype="dashed") +
  facet_grid(chain~amount, space="free", scales="free") +
  scale_x_log10("Frequency in pool", limits=c(1e-6,1e-1), breaks=10^(-6:-1)) +
  scale_y_log10("Frequency in replica", limits=c(1e-6,1e-1), breaks=10^(-6:-1)) +
  scale_color_brewer(palette = "Paired") +
  theme_light()
```

Distribution of clonotype count in 8 and 65 ng samples for clonotypes from different frequency tiers.

```{r}
df.2 = df.1 %>%
  mutate(log.freq = round(5*log10(count.total/count.grand))/5) %>%
  group_by(count, amount, chain, log.freq) %>%
  summarize(nn = n()) %>%
  group_by(amount, log.freq) %>%
  mutate(P = nn / sum(nn))

rf <- colorRampPalette(rev(brewer.pal(11, 'Spectral')))
r <- rf(40)

ggplot(subset(df.2), aes(x = count, y = nn, color=10^log.freq,
                         group=factor(log.freq))) +
  geom_line() +
  geom_point() +
  facet_grid(chain~amount, space="free", scales="free") +
  scale_y_log10("Number of clonotypes") + scale_x_log10("Count in sample") +
  scale_color_gradientn("Frequency", colors=r, trans="log") +
  theme_light()
```

Coefficient of variance versus clonotype abundance. Dashed and dotted lines show CV of Poisson and Beta Binomial distribution with $B(0,0)$ prior respectively.

```{r}
df.3 = df.1 %>%
  group_by(amount, chain, count.total, count.grand) %>%
  summarize(count.mean = mean(count), 
            count.sd = sd(count) * 2 / 3,
            mean.replica.size = mean(count.replica.total)) %>%
  group_by(count.mean, mean.replica.size) %>%
  mutate(a = count.mean + 0,
         b = mean.replica.size - count.mean + 0,
         bb.mean = mean.replica.size * a / (a + b),
         bb.sd = sqrt(mean.replica.size * a * b * (a + b + mean.replica.size) / (a + b) / (a + b) / (a + b + 1)))

ggplot(df.3) + 
  #geom_smooth(color="black") +
  geom_point(aes(x=count.mean, y = count.sd / count.mean, 
                 fill=10^(round(5*log10(count.total/count.grand))/5)), color="black", shape=21) +
  geom_line(aes(x=count.mean, y = 1 / sqrt(count.mean)), color="black", linetype="dashed") +
  geom_line(aes(x=count.mean, y = bb.sd / bb.mean), color="black", linetype="dotted") +
  facet_grid(chain~amount) +
  scale_y_continuous("Coefficient of variance", labels = percent) +
  scale_x_log10("Mean count", breaks = c(0.1, 1, 10, 100)) +
  scale_fill_gradientn("Frequency", colors=r, trans="log") +
  theme_light()
```

```{r}
library(TailRank)

dbb = function (x, N, u, v) 
{
    beta(x + u, N - x + v) / beta(u, v) * choose(N, x)
}

dbbl = function (x, N, u, v) 
{
    betal(x + u, N - x + v) - betal(u, v) + lchoose(N, x)
}

# Use Jeffreys prior
df.1$alpha = df.1$count.total + 1/2
df.1$beta = df.1$count.grand - df.1$count.total + 1/2

bbnll = function(pars, data){
  A <- pars[[1]]
  B <- pars[[2]]
  
  
  
  return (-sum(dbb(data, alpha, beta, log = T)))
}

param_guess = function(data) {
  с(1, 1/2) # ala Jeffreys prior
}

fit_beta <- function(data) {
  list(nloptr(x0 = param_guess(data), eval_f = betanll, 
              lb = c(0,0), data = data,
              opts = list(algorithm = "NLOPT_LN_SBPLX", 
                          maxeval = 1e5))$solution)
}

fit.params <- df.1 %>% 
  group_by(mutation.type) %>%
  summarize(fit = fit_beta(freq))

fit.params$alpha <- unlist(lapply(fit.params$fit, function(x) x[1]))
fit.params$beta <- unlist(lapply(fit.params$fit, function(x) x[2]))
fit.params$fit <- NULL
```
